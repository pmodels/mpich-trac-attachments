<html><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; ">Forwarding to make sure that this is in the bug tracking system. &nbsp;The fix is currently blocked on ticket #771 .<div><br></div><div>Bill<br><div><br><div>Begin forwarded message:</div><br class="Apple-interchange-newline"><blockquote type="cite"><div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>From: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Rajeev Thakur &lt;<a href="mailto:thakur@mcs.anl.gov">thakur@mcs.anl.gov</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Date: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">July 21, 2009 11:25:11 AM CDT</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>To: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">"Gropp, William D" &lt;<a href="mailto:wgropp@illinois.edu">wgropp@illinois.edu</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Subject: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica"><b>FW: [mpich2-dev] fandcattrf90 test on BGP</b></font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; min-height: 14px; "><br></div> </div> <div> <div dir="ltr" align="left"><span class="187332416-21072009"><font color="#0000ff" size="2" face="Arial">Bill,</font></span></div> <div dir="ltr" align="left"><span class="187332416-21072009"><font color="#0000ff" size="2" face="Arial">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; What do you think of this? Attribute stuff is too complex for me :-(</font></span></div> <div dir="ltr" align="left"><span class="187332416-21072009"><font color="#0000ff" size="2" face="Arial"></font></span>&nbsp;</div> <div dir="ltr" align="left"><span class="187332416-21072009"><font color="#0000ff" size="2" face="Arial">Rajeev</font></span></div><br> <div dir="ltr" lang="en-us" class="OutlookMessageHeader" align="left"> <hr tabindex="-1"> <font size="2" face="Tahoma"><b>From:</b> mpich2-dev-bounces@mcs.anl.gov [<a href="mailto:mpich2-dev-bounces@mcs.anl.gov">mailto:mpich2-dev-bounces@mcs.anl.gov</a>] <b>On Behalf Of </b>Joe Ratterman<br><b>Sent:</b> Thursday, July 16, 2009 4:56 PM<br><b>To:</b> MPICH2 Dev<br><b>Subject:</b> [mpich2-dev] fandcattrf90 test on BGP<br></font><br></div> <div></div> <div class="gmail_quote"> <div class="gmail_quote">(This is a re-send; I got a pile of python errors on the last try)</div><br> <div><a href="https://svn.mcs.anl.gov/repos/mpi/mpich2/trunk/test/mpi/f90/attr/fandcattrf90.f90" target="_blank">https://svn.mcs.anl.gov/repos/mpi/mpich2/trunk/test/mpi/f90/attr/fandcattrf90.f90</a></div> <div><a href="https://svn.mcs.anl.gov/repos/mpi/mpich2/trunk/test/mpi/f90/attr/fandcattrc.c" target="_blank">https://svn.mcs.anl.gov/repos/mpi/mpich2/trunk/test/mpi/f90/attr/fandcattrc.c</a></div> <div><br></div>This test creates an attribute in F90, sets it in F90, and then reads it back in C. &nbsp;It was getting the wrong answer: <div><font face="'courier new', monospace">Expected: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5555 (0x15b3)</font></div> <div><font face="'courier new', monospace">Actual: &nbsp;&nbsp;23858543329280&nbsp;(0x15b300000000)</font></div> <div><br></div> <div><br></div> <div><b>fandcattrf90.f90 excerpt</b></div> <div><br></div> <blockquote style="BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; PADDING-BOTTOM: 0px; MARGIN: 0px 0px 0px 40px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BORDER-TOP: medium none; BORDER-RIGHT: medium none; PADDING-TOP: 0px"><font face="'courier new', monospace">&nbsp;&nbsp; &nbsp; &nbsp;program   main<br>&nbsp;&nbsp; &nbsp; &nbsp;use mpi<br>&nbsp;&nbsp; &nbsp; &nbsp;integer   (kind=MPI_ADDRESS_KIND) val<br><br>&nbsp;&nbsp; &nbsp; &nbsp;errs &nbsp;   &nbsp; &nbsp;= 0<br>&nbsp;&nbsp; &nbsp; &nbsp;call   mpi_init(ierr)<br>&nbsp;&nbsp; &nbsp; &nbsp;commextra = 1001<br>&nbsp;&nbsp;   &nbsp; &nbsp;call mpi_comm_create_keyval( mycopyfn, mydelfn, &nbsp; &nbsp;   &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;<br>&nbsp;&nbsp;   &nbsp; &amp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;   &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fcomm2_keyval, commextra, ierr   )<br>&nbsp;&nbsp; &nbsp; &nbsp;val = 5555<br>&nbsp;&nbsp; &nbsp; &nbsp;call   mpi_comm_set_attr( MPI_COMM_WORLD, fcomm2_keyval, val, ierr )<br>&nbsp;&nbsp;   &nbsp; &nbsp;call chkcomm2inc( fcomm2_keyval, 5555, errs )</font></blockquote> <div><br></div> <div><br></div> <div><br></div> <div><b>fandcattrc.c excerpt</b></div> <div><br></div> <blockquote style="BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; PADDING-BOTTOM: 0px; MARGIN: 0px 0px 0px 40px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BORDER-TOP: medium none; BORDER-RIGHT: medium none; PADDING-TOP: 0px"><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">int chkcomm2inc_ (int   *keyval, const int *expected, int *ierr)</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">{</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp; &nbsp;int   &nbsp; &nbsp; &nbsp;flag;</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp;   &nbsp;MPI_Aint *val;</span><br><font size="2" face="'courier new'"><span style="FONT-SIZE: 10px"><br></span></font><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp; &nbsp;/* See   Example 16.19 in MPI 2.2, part B. &nbsp;The use of MPI_Aint   *val</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp; &nbsp; &nbsp;   and the address of val in the get_attr call is correct, as is</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp; &nbsp; &nbsp;   the use of *val to access the value. */</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp;   &nbsp;MPI_Comm_get_attr( MPI_COMM_WORLD, *keyval, &amp;val, &amp;flag   );</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp; &nbsp;if   (!flag) {</span><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">*ierr = 1;</font><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp;   &nbsp;}</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp; &nbsp;else   {</span><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">if (*val != *expected) {</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">&nbsp; &nbsp;/* In some cases, using printf   from a c routine linked&nbsp;</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">&nbsp; &nbsp; &nbsp; with a Fortran routine   can cause linking difficulties.</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">&nbsp; &nbsp; &nbsp; To avoid problems in   running the tests, this print</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">&nbsp; &nbsp; &nbsp; is commented out   */</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">&nbsp; &nbsp;/* printf( "Val = %x, expected =   %d\n", val, *expected ); */</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">&nbsp; &nbsp;*ierr = *ierr +   1;</font><br><span style="WHITE-SPACE: pre"><font face="'courier new', monospace"></font></span><font face="'courier new', monospace">}</font><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">&nbsp;&nbsp;   &nbsp;}</span><br><span style="FONT-FAMILY: 'courier new'; FONT-SIZE: 10px">}</span></blockquote> <div><br></div> <div><br></div> <div><br></div> <div>BGP has an 8-byte MPI_Aint and a 4-byte void*, which seems to be the root of the problem. &nbsp;MPI_Comm_get_attr() stores the integer data in a void* internally. &nbsp;That means that there are only 4 bytes of actual data, but *(MPI_Aint*)val tries to read 8 bytes. &nbsp;Effectively, that means that MPI_Comm_get_attr() only returns an int*. &nbsp;This is a problem caused by assuming that everything--specifically including MPI_Aint values--will fit in the space used by a void*. &nbsp;The solution is to store all attributes in an MPI_Aint. Since an MPI_Aint clearly cannot be smaller than a void*, this will work fine. &nbsp;There is already special code to handle the case of storing a 4-byte big-endian int in a 8-byte void*, so a 4-byte void* in a 8-byte MPI_Aint would be very similar.</div> <div> <div><br></div> <div>One idea that strikes me as really good is to change the "value" field in the MPID_Attribute structure to be a union of int, void*, and MPI_Aint types with three different names. &nbsp;That would get rid of the <i>interesting</i> work that is required to handle 8-byte void* and 4-byte ints. &nbsp;It would also make it easier to add MPI_Aint changes. &nbsp;You wouldn't have to worry about the strangeness of storing an integer type in a pointer type, and it would automatically handle any differences in the sizes of the elements. &nbsp;You already track the data type, so you would know into which element the attribute should be stored.</div> <div><br></div> <div><br></div> <div>Comments or questions?</div> <div><br></div><font color="#888888"> <div>Joe Ratterman</div> <div><a href="mailto:jratt@us.ibm.com" target="_blank">jratt@us.ibm.com</a></div></font></div></div><br></div></blockquote></div><br><div> <span class="Apple-style-span" style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-align: auto; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0; "><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; "><span class="Apple-style-span" style="border-collapse: separate; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; -webkit-text-decorations-in-effect: none; text-indent: 0px; -webkit-text-size-adjust: auto; text-transform: none; orphans: 2; white-space: normal; widows: 2; word-spacing: 0px; "><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; "><div>William&nbsp;Gropp</div><div>Deputy Director for Research</div><div>Institute for Advanced Computing Applications and Technologies</div><div>Paul and Cynthia Saylor Professor of Computer Science</div><div>University of Illinois Urbana-Champaign</div><div><br class="khtml-block-placeholder"></div></div><br class="Apple-interchange-newline"></span></div></span><br class="Apple-interchange-newline"> </div><br></div></body></html>